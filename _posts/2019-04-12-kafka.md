---
layout: post
title:  "kafka简介"
date:   2019-04-12 10:20:10
categories: others
tags: kafka 架构
---

* content
{:toc}

Apache Kafka是一个分布式流处理平台，他有三个关键能力：

* 发布和订阅消息流，类似于消息队列或者企业级消息系统。
* 高可用的持久存储消息流。
* 实时处理消息流

kafka的一些概念：

* kafka可以运行在分布于多个数据中心的集群上面。
* kafka通过`topic`来区分不同类别的消息。
* 每条消息包含一个key、value和时间戳。

### kafka的总体架构

应用（生产者）发送消息到kafka的一个节点上（`broker`），然后这个消息被其他叫做消费者的应用处理。
这个消息被存放在`topic`中，消费者通过订阅这个`topic`来接收新消息。  
![kafka-apis]({{"/css/pics/kafka/kafka-apis.png"}})  

由于一个`topic`可能会非常大，出于性能和扩展性考虑，可以将`topic`再分成多个小的`partitions`。
kafka保证一个`partitions`中所有消息的存放顺序和消息进入的顺序一致。  
一个特定的消息是通过偏移量（`offset`）来确定的，你可以把他看作为一个普通的数组索引或者序列号，`partitions`中每进来一个新消息都会递增这个索引。  
![log_anatomy]({{"/css/pics/kafka/log_anatomy.png"}})  

kafka不会因为某个消息被消费者读取了之后就删除这条消息，而是保存消息到达一定时间（例如一天）或者当消息数量到达设置的值后才会删除消息。
消费者通过序列号在kafka中查询自己想要读取的消息，这意味着他们可以读取任意消息，从而实现重放和重复处理的功能。

### 数据存储

每个`partitions`在多个`broker`上有备份，防止一个`broker`死机导致这个`partitions`不可用。
任何时候都有一个`broker`上有一个主`partitions`来接收外部读写请求。其他的备份`partitions`叫做`followers`。
他们接收主发送的备份数据存储下来，并时刻等待当主挂掉之后被选举为主`partitions`。

如下图：一个topic被分为两个partitions，每个partitions有三个备份分布在不同broker上，其中一个为主另外两个为从。
主节点接收外部读写请求，并将数据同步到从节点上。  
![kafka_data]({{"/css/pics/kafka/kafka_data.png"}})  

当生产者需要写数据时首先向kafka的一个broker节点发送metadata请求，broker节点会返回他要写的数据的主partitions是哪一个节点，
然后生产者再次发送写请求到该节点上。每个broker节点的信息是由`Zookeeper`来维护以及下发到各节点的。  
![kafka_write]({{"/css/pics/kafka/kafka_write.png"}})  


### 参考



[kafka官方文档](http://kafka.apache.org/documentation/)  
[Thorough Introduction to Apache Kafka](https://hackernoon.com/thorough-introduction-to-apache-kafka-6fbf2989bbc1)  
[Zookeeper的功能以及工作原理](https://www.cnblogs.com/felixzh/p/5869212.html)  
